 el // NIDIA Flow - SuperAdmin Database Schema
// This schema manages all tenants and NIDIA's business operations

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANTS MANAGEMENT
// ============================================

model Tenant {
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String  @db.VarChar(255)
  slug             String  @unique @db.VarChar(100)
  companyLegalName String? @map("company_legal_name") @db.VarChar(255)
  taxId            String? @map("tax_id") @db.VarChar(50)
  industry         String? @db.VarChar(100)
  companySize      String? @map("company_size") @db.VarChar(50)

  // Subscription info
  planType             String    @default("free") @map("plan_type") @db.VarChar(50)
  planStatus           String    @default("trial") @map("plan_status") @db.VarChar(50)
  trialEndsAt          DateTime? @map("trial_ends_at")
  subscriptionStartsAt DateTime? @map("subscription_starts_at")
  subscriptionEndsAt   DateTime? @map("subscription_ends_at")

  // Database connection info
  dbName               String @unique @map("db_name") @db.VarChar(100)
  dbHost               String @map("db_host") @db.VarChar(255)
  dbPort               Int    @default(5432) @map("db_port")
  dbUsername           String @map("db_username") @db.VarChar(100)
  dbPasswordEncrypted  String @map("db_password_encrypted") @db.Text
  dbConnectionPoolSize Int    @default(10) @map("db_connection_pool_size")

  // Billing
  billingEmail       String  @map("billing_email") @db.VarChar(255)
  billingContactName String? @map("billing_contact_name") @db.VarChar(255)
  billingAddress     String? @map("billing_address") @db.Text
  billingCity        String? @map("billing_city") @db.VarChar(100)
  billingState       String? @map("billing_state") @db.VarChar(100)
  billingCountry     String  @default("CO") @map("billing_country") @db.VarChar(2)
  billingPostalCode  String? @map("billing_postal_code") @db.VarChar(20)
  paymentMethod      String? @map("payment_method") @db.VarChar(50)

  // Stripe/Payment provider
  stripeCustomerId     String? @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String? @map("stripe_subscription_id") @db.VarChar(255)

  // Usage limits
  maxUsers           Int @default(5) @map("max_users")
  maxStorageGb       Int @default(2) @map("max_storage_gb")
  maxMonthlyEmails   Int @default(1000) @map("max_monthly_emails")
  maxMonthlyWhatsapp Int @default(500) @map("max_monthly_whatsapp")
  maxMonthlyApiCalls Int @default(10000) @map("max_monthly_api_calls")

  // Current usage
  currentUsers           Int     @default(0) @map("current_users")
  currentStorageGb       Decimal @default(0) @map("current_storage_gb") @db.Decimal(10, 2)
  currentMonthlyEmails   Int     @default(0) @map("current_monthly_emails")
  currentMonthlyWhatsapp Int     @default(0) @map("current_monthly_whatsapp")
  currentMonthlyApiCalls Int     @default(0) @map("current_monthly_api_calls")

  // Status & health
  isActive         Boolean   @default(true) @map("is_active")
  isSuspended      Boolean   @default(false) @map("is_suspended")
  suspensionReason String?   @map("suspension_reason") @db.Text
  suspendedAt      DateTime? @map("suspended_at")
  provisionedAt    DateTime? @map("provisioned_at")
  lastActivityAt   DateTime? @map("last_activity_at")
  lastBillingDate  DateTime? @map("last_billing_date")
  nextBillingDate  DateTime? @map("next_billing_date")

  // Contact info
  primaryContactName  String? @map("primary_contact_name") @db.VarChar(255)
  primaryContactEmail String? @map("primary_contact_email") @db.VarChar(255)
  primaryContactPhone String? @map("primary_contact_phone") @db.VarChar(20)

  // Onboarding
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  onboardingStep      Int     @default(1) @map("onboarding_step")

  // Features & modules
  enabledModules String[] @map("enabled_modules")
  featureFlags   Json     @default("{}") @map("feature_flags")

  // Metadata
  settings       Json     @default("{}") @map("settings")
  metadata       Json     @default("{}") @map("metadata")
  referralSource String?  @map("referral_source") @db.VarChar(100)
  notes          String?  @map("notes") @db.Text
  createdBy      String?  @map("created_by") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  domains             TenantDomain[]
  users               User[]
  subscriptions       Subscription[]
  invoices            Invoice[]
  paymentMethods      PaymentMethod[]
  couponRedemptions   CouponRedemption[]
  licenses            License[]
  usageDaily          TenantUsageDaily[]
  activityLogs        TenantActivityLog[]
  supportTickets      SupportTicket[]
  systemNotifications SystemNotification[]
  auditLogs           AuditLog[]
  gdprRequests        GdprRequest[]
  webhookEndpoints    WebhookEndpoint[]
  createdByUser       User?                @relation("TenantCreatedBy", fields: [createdBy], references: [id])

  @@index([slug])
  @@index([planType])
  @@index([planStatus])
  @@index([isActive])
  @@index([planType, planStatus])
  @@index([nextBillingDate])
  @@index([trialEndsAt])
  @@map("tenants")
}

model TenantDomain {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  domain            String    @unique @db.VarChar(255)
  isCustom          Boolean   @default(false) @map("is_custom")
  isVerified        Boolean   @default(false) @map("is_verified")
  isPrimary         Boolean   @default(false) @map("is_primary")
  sslEnabled        Boolean   @default(false) @map("ssl_enabled")
  verificationToken String?   @map("verification_token") @db.VarChar(255)
  verifiedAt        DateTime? @map("verified_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([domain])
  @@index([isVerified])
  @@map("tenant_domains")
}

model User {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String? @map("tenant_id") @db.Uuid
  email        String  @unique @db.VarChar(255)
  passwordHash String  @map("password_hash") @db.VarChar(255)
  firstName    String? @map("first_name") @db.VarChar(100)
  lastName     String? @map("last_name") @db.VarChar(100)
  phone        String? @db.VarChar(20)
  avatarUrl    String? @map("avatar_url") @db.VarChar(500)

  systemRole String @default("tenant_admin") @map("system_role") @db.VarChar(50)

  // Auth & security
  emailVerified          Boolean   @default(false) @map("email_verified")
  emailVerifiedAt        DateTime? @map("email_verified_at")
  emailVerificationToken String?   @map("email_verification_token") @db.VarChar(255)
  mfaEnabled             Boolean   @default(false) @map("mfa_enabled")
  mfaSecret              String?   @map("mfa_secret") @db.VarChar(255)

  // Password reset
  resetToken          String?   @map("reset_token") @db.VarChar(255)
  resetTokenExpiresAt DateTime? @map("reset_token_expires_at")

  // Status
  isActive      Boolean   @default(true) @map("is_active")
  isLocked      Boolean   @default(false) @map("is_locked")
  lockedReason  String?   @map("locked_reason") @db.Text
  lockedAt      DateTime? @map("locked_at")
  lastLoginAt   DateTime? @map("last_login_at")
  lastLoginIp   String?   @map("last_login_ip") @db.VarChar(45)
  loginAttempts Int       @default(0) @map("login_attempts")

  // Preferences
  language String @default("es") @db.VarChar(10)
  timezone String @default("America/Bogota") @db.VarChar(50)

  // Metadata
  metadata  Json     @default("{}") @map("metadata")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant                     Tenant?              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions                   UserSession[]
  supportTicketsCreated      SupportTicket[]      @relation("TicketCreatedBy")
  supportTicketsAssigned     SupportTicket[]      @relation("TicketAssignedTo")
  ticketMessages             TicketMessage[]
  systemNotificationsCreated SystemNotification[] @relation("NotificationCreatedBy")
  emailCampaignsCreated      EmailCampaign[]      @relation("CampaignCreatedBy")
  auditLogsUser              AuditLog[]           @relation("AuditLogUser")
  gdprRequestsUser           GdprRequest[]        @relation("GdprRequestUser")
  systemSettingsUpdated      SystemSetting[]      @relation("SettingUpdatedBy")
  tenantsCreated             Tenant[]             @relation("TenantCreatedBy")

  @@unique([tenantId, email])
  @@index([email])
  @@index([tenantId])
  @@index([systemRole])
  @@index([isActive])
  @@map("users")
}

model UserSession {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  tokenHash      String    @map("token_hash") @db.VarChar(255)
  deviceName     String?   @map("device_name") @db.VarChar(255)
  deviceType     String?   @map("device_type") @db.VarChar(50)
  ipAddress      String?   @map("ip_address") @db.VarChar(45)
  userAgent      String?   @map("user_agent") @db.Text
  isActive       Boolean   @default(true) @map("is_active")
  lastActivityAt DateTime? @map("last_activity_at")
  expiresAt      DateTime  @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([isActive])
  @@index([expiresAt])
  @@map("user_sessions")
}

model Plan {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String  @unique @db.VarChar(100)
  displayName String  @map("display_name") @db.VarChar(255)
  description String? @db.Text

  // Pricing
  priceMonthly Decimal? @map("price_monthly") @db.Decimal(10, 2)
  priceYearly  Decimal? @map("price_yearly") @db.Decimal(10, 2)
  currency     String   @default("USD") @db.VarChar(3)

  // Limits
  maxUsers           Int? @map("max_users")
  maxStorageGb       Int? @map("max_storage_gb")
  maxMonthlyEmails   Int? @map("max_monthly_emails")
  maxMonthlyWhatsapp Int? @map("max_monthly_whatsapp")
  maxMonthlyApiCalls Int? @map("max_monthly_api_calls")

  // Features
  features       Json     @map("features")
  enabledModules String[] @map("enabled_modules")

  // Stripe
  stripePriceIdMonthly String? @map("stripe_price_id_monthly") @db.VarChar(255)
  stripePriceIdYearly  String? @map("stripe_price_id_yearly") @db.VarChar(255)

  isActive  Boolean  @default(true) @map("is_active")
  isVisible Boolean  @default(true) @map("is_visible")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@index([name])
  @@index([isActive])
  @@index([isVisible])
  @@map("plans")
}

model Subscription {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String @map("tenant_id") @db.Uuid
  planId       String @map("plan_id") @db.Uuid
  billingCycle String @map("billing_cycle") @db.VarChar(20)

  // Pricing
  amount         Decimal @map("amount") @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal @map("total_amount") @db.Decimal(10, 2)
  currency       String  @default("USD") @db.VarChar(3)

  // Status
  status String @map("status") @db.VarChar(50)

  // Periods
  currentPeriodStart DateTime @map("current_period_start")
  currentPeriodEnd   DateTime @map("current_period_end")

  // Cancellation
  cancelAtPeriodEnd  Boolean   @default(false) @map("cancel_at_period_end")
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason") @db.Text

  // Trial
  trialStart DateTime? @map("trial_start")
  trialEnd   DateTime? @map("trial_end")

  // Payment provider
  stripeSubscriptionId String? @map("stripe_subscription_id") @db.VarChar(255)
  stripeCustomerId     String? @map("stripe_customer_id") @db.VarChar(255)

  // Metadata
  metadata  Json     @default("{}") @map("metadata")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan              Plan               @relation(fields: [planId], references: [id])
  invoices          Invoice[]
  couponRedemptions CouponRedemption[]

  @@index([tenantId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model Invoice {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String  @map("tenant_id") @db.Uuid
  subscriptionId String? @map("subscription_id") @db.Uuid
  invoiceNumber  String  @unique @map("invoice_number") @db.VarChar(50)

  // Amounts
  amountSubtotal Decimal @map("amount_subtotal") @db.Decimal(10, 2)
  amountDiscount Decimal @default(0) @map("amount_discount") @db.Decimal(10, 2)
  amountTax      Decimal @default(0) @map("amount_tax") @db.Decimal(10, 2)
  amountTotal    Decimal @map("amount_total") @db.Decimal(10, 2)
  currency       String  @default("USD") @db.VarChar(3)

  // Status
  status String @map("status") @db.VarChar(50)

  // Dates
  issuedAt DateTime  @map("issued_at")
  dueDate  DateTime? @map("due_date")
  paidAt   DateTime? @map("paid_at")

  // Payment
  paymentMethod    String? @map("payment_method") @db.VarChar(50)
  paymentReference String? @map("payment_reference") @db.VarChar(255)

  // Stripe
  stripeInvoiceId       String? @map("stripe_invoice_id") @db.VarChar(255)
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(255)

  // Files
  pdfUrl String? @map("pdf_url") @db.VarChar(500)

  // Items detail
  lineItems Json @map("line_items")

  // Notes
  notes     String?  @map("notes") @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([issuedAt])
  @@index([dueDate])
  @@map("invoices")
}

model PaymentMethod {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid
  type     String @map("type") @db.VarChar(50)

  // Card info (last 4 digits only)
  cardBrand    String? @map("card_brand") @db.VarChar(50)
  cardLast4    String? @map("card_last4") @db.VarChar(4)
  cardExpMonth Int?    @map("card_exp_month")
  cardExpYear  Int?    @map("card_exp_year")

  // Bank account
  bankName     String? @map("bank_name") @db.VarChar(255)
  accountLast4 String? @map("account_last4") @db.VarChar(4)

  isDefault Boolean @default(false) @map("is_default")
  isActive  Boolean @default(true) @map("is_active")

  // Stripe
  stripePaymentMethodId String? @map("stripe_payment_method_id") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isDefault])
  @@index([stripePaymentMethodId])
  @@map("payment_methods")
}

model Coupon {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String  @unique @db.VarChar(50)
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Discount
  discountType  String  @map("discount_type") @db.VarChar(20)
  discountValue Decimal @map("discount_value") @db.Decimal(10, 2)
  currency      String  @default("USD") @db.VarChar(3)

  // Applicability
  appliesTo         String?  @map("applies_to") @db.VarChar(50)
  applicablePlanIds String[] @map("applicable_plan_ids")

  // Limits
  maxRedemptions          Int? @map("max_redemptions")
  currentRedemptions      Int  @default(0) @map("current_redemptions")
  maxRedemptionsPerTenant Int  @default(1) @map("max_redemptions_per_tenant")

  // Duration
  duration         String @map("duration") @db.VarChar(20)
  durationInMonths Int?   @map("duration_in_months")

  // Validity
  validFrom  DateTime? @map("valid_from")
  validUntil DateTime? @map("valid_until")
  isActive   Boolean   @default(true) @map("is_active")

  // Metadata
  notes     String?  @map("notes") @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  redemptions CouponRedemption[]

  @@index([code])
  @@index([isActive])
  @@index([validUntil])
  @@map("coupons")
}

model CouponRedemption {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  couponId       String  @map("coupon_id") @db.Uuid
  tenantId       String  @map("tenant_id") @db.Uuid
  subscriptionId String? @map("subscription_id") @db.Uuid

  // Discount applied
  discountAmount Decimal  @map("discount_amount") @db.Decimal(10, 2)
  redeemedAt     DateTime @default(now()) @map("redeemed_at")

  coupon       Coupon        @relation(fields: [couponId], references: [id])
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([couponId])
  @@index([tenantId])
  @@index([subscriptionId])
  @@map("coupon_redemptions")
}

model License {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  licenseKey  String  @unique @map("license_key") @db.VarChar(255)
  licenseType String  @map("license_type") @db.VarChar(50)
  moduleName  String? @map("module_name") @db.VarChar(100)
  featureName String? @map("feature_name") @db.VarChar(100)

  // License details
  maxActivations     Int @default(1) @map("max_activations")
  currentActivations Int @default(0) @map("current_activations")

  // Validity
  isActive    Boolean   @default(true) @map("is_active")
  activatedAt DateTime? @map("activated_at")
  expiresAt   DateTime? @map("expires_at")

  // Metadata
  metadata  Json     @default("{}") @map("metadata")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  activations LicenseActivation[]

  @@index([tenantId])
  @@index([licenseKey])
  @@index([licenseType, moduleName])
  @@index([expiresAt])
  @@index([isActive])
  @@map("licenses")
}

model LicenseActivation {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  licenseId     String    @map("license_id") @db.Uuid
  deviceId      String?   @map("device_id") @db.VarChar(255)
  deviceName    String?   @map("device_name") @db.VarChar(255)
  deviceType    String?   @map("device_type") @db.VarChar(50)
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  activatedAt   DateTime  @default(now()) @map("activated_at")
  lastCheckedAt DateTime? @map("last_checked_at")
  isActive      Boolean   @default(true) @map("is_active")
  deactivatedAt DateTime? @map("deactivated_at")

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@index([licenseId])
  @@index([isActive])
  @@map("license_activations")
}

model TenantUsageDaily {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  usageDate DateTime @map("usage_date") @db.Date

  // Metrics
  activeUsers  Int     @default(0) @map("active_users")
  apiCalls     Int     @default(0) @map("api_calls")
  storageGb    Decimal @default(0) @map("storage_gb") @db.Decimal(10, 2)
  emailsSent   Int     @default(0) @map("emails_sent")
  whatsappSent Int     @default(0) @map("whatsapp_sent")

  // Activity
  ordersCreated  Int @default(0) @map("orders_created")
  tasksCompleted Int @default(0) @map("tasks_completed")
  customersAdded Int @default(0) @map("customers_added")

  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, usageDate])
  @@index([tenantId])
  @@index([usageDate])
  @@map("tenant_usage_daily")
}

model SupportTicket {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String? @map("tenant_id") @db.Uuid
  ticketNumber String  @unique @map("ticket_number") @db.VarChar(50)

  // Basic info
  subject     String @db.VarChar(500)
  description String @db.Text
  category    String @db.VarChar(100)
  priority    String @default("medium") @db.VarChar(50)
  status      String @default("open") @db.VarChar(50)

  // Assignment
  createdBy  String    @map("created_by") @db.Uuid
  assignedTo String?   @map("assigned_to") @db.Uuid
  assignedAt DateTime? @map("assigned_at")

  // Resolution
  resolvedAt DateTime? @map("resolved_at")
  closedAt   DateTime? @map("closed_at")
  resolution String?   @db.Text

  // Customer satisfaction
  satisfactionRating   Int?    @map("satisfaction_rating")
  satisfactionFeedback String? @map("satisfaction_feedback") @db.Text

  // SLA tracking
  firstResponseAt DateTime? @map("first_response_at")
  slaBreached     Boolean   @default(false) @map("sla_breached")

  // Metadata
  tags      String[] @map("tags")
  metadata  Json     @default("{}") @map("metadata")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant         Tenant?         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser  User            @relation("TicketCreatedBy", fields: [createdBy], references: [id])
  assignedToUser User?           @relation("TicketAssignedTo", fields: [assignedTo], references: [id])
  messages       TicketMessage[]

  @@index([tenantId])
  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([createdBy])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("support_tickets")
}

model TicketMessage {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId   String  @map("ticket_id") @db.Uuid
  userId     String  @map("user_id") @db.Uuid
  isStaff    Boolean @default(false) @map("is_staff")
  message    String  @db.Text
  isInternal Boolean @default(false) @map("is_internal")

  // Attachments
  attachments String[] @map("attachments")

  createdAt DateTime @default(now()) @map("created_at")

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@map("ticket_messages")
}

model SystemNotification {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String? @map("tenant_id") @db.Uuid

  // Content
  type     String @db.VarChar(50)
  title    String @db.VarChar(255)
  message  String @db.Text
  severity String @db.VarChar(20)

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Scheduling
  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")

  // Display
  showInDashboard Boolean @default(true) @map("show_in_dashboard")
  showAsBanner    Boolean @default(false) @map("show_as_banner")

  // Metadata
  createdBy String   @map("created_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  tenant        Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser User    @relation("NotificationCreatedBy", fields: [createdBy], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([severity])
  @@index([isActive])
  @@index([startsAt])
  @@map("system_notifications")
}

model EmailCampaign {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name    String @db.VarChar(255)
  subject String @db.VarChar(255)

  // Targeting
  targetAudience String  @map("target_audience") @db.VarChar(50)
  targetPlanType String? @map("target_plan_type") @db.VarChar(50)

  // Content
  emailTemplate String @map("email_template") @db.Text

  // Status
  status String @default("draft") @db.VarChar(50)

  // Scheduling
  scheduledAt DateTime? @map("scheduled_at")
  sentAt      DateTime? @map("sent_at")

  // Stats
  totalRecipients Int @default(0) @map("total_recipients")
  totalSent       Int @default(0) @map("total_sent")
  totalDelivered  Int @default(0) @map("total_delivered")
  totalOpened     Int @default(0) @map("total_opened")
  totalClicked    Int @default(0) @map("total_clicked")

  // Metadata
  createdBy String   @map("created_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  createdByUser User @relation("CampaignCreatedBy", fields: [createdBy], references: [id])

  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
  @@map("email_campaigns")
}

model TenantActivityLog {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  // Activity details
  eventType     String @map("event_type") @db.VarChar(100)
  eventCategory String @map("event_category") @db.VarChar(50)

  // Context
  userId    String? @map("user_id") @db.Uuid
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Metadata
  metadata  Json     @default("{}") @map("metadata")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([eventType])
  @@index([eventCategory])
  @@index([createdAt])
  @@map("tenant_activity_logs")
}

model AuditLog {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String? @map("tenant_id") @db.Uuid

  // Action details
  action     String @db.VarChar(100)
  entityType String @map("entity_type") @db.VarChar(100)
  entityId   String @map("entity_id") @db.Uuid

  // Changes
  oldValues Json? @map("old_values")
  newValues Json? @map("new_values")

  // Context
  userId    String  @map("user_id") @db.Uuid
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Metadata
  metadata  Json     @default("{}") @map("metadata")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User    @relation("AuditLogUser", fields: [userId], references: [id])

  @@index([tenantId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model GdprRequest {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String  @map("tenant_id") @db.Uuid
  userId   String? @map("user_id") @db.Uuid

  // Request details
  requestType String @map("request_type") @db.VarChar(50)
  status      String @default("pending") @db.VarChar(50)

  // Dates
  requestedAt DateTime  @default(now()) @map("requested_at")
  completedAt DateTime? @map("completed_at")

  // Results
  exportFileUrl     String? @map("export_file_url") @db.VarChar(500)
  deletionCompleted Boolean @default(false) @map("deletion_completed")
  notes             String? @db.Text

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation("GdprRequestUser", fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([requestType])
  @@index([status])
  @@map("gdpr_requests")
}

model SystemSetting {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       Json     @db.JsonB
  description String?  @db.Text
  isPublic    Boolean  @default(false) @map("is_public")
  updatedBy   String?  @map("updated_by") @db.Uuid
  updatedAt   DateTime @default(now()) @map("updated_at")

  updatedByUser User? @relation("SettingUpdatedBy", fields: [updatedBy], references: [id])

  @@index([key])
  @@map("system_settings")
}

model FeatureFlag {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String  @unique @db.VarChar(100)
  description String? @db.Text

  // Status
  isEnabled Boolean @default(false) @map("is_enabled")

  // Rollout configuration
  rolloutPercentage Int      @default(0) @map("rollout_percentage")
  enabledForTenants String[] @map("enabled_for_tenants")

  // Metadata
  metadata  Json     @default("{}") @map("metadata")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([name])
  @@index([isEnabled])
  @@map("feature_flags")
}

model WebhookEndpoint {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String? @map("tenant_id") @db.Uuid

  // Endpoint details
  url         String  @db.VarChar(500)
  description String? @db.Text

  // Events
  enabledEvents String[] @map("enabled_events")

  // Security
  secret String @db.VarChar(255)

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Stats
  lastTriggeredAt DateTime? @map("last_triggered_at")
  successCount    Int       @default(0) @map("success_count")
  failureCount    Int       @default(0) @map("failure_count")

  // Metadata
  metadata  Json     @default("{}") @map("metadata")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant     Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([tenantId])
  @@index([isActive])
  @@map("webhook_endpoints")
}

model WebhookDelivery {
  id                String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  webhookEndpointId String @map("webhook_endpoint_id") @db.Uuid

  // Event details
  eventType String @map("event_type") @db.VarChar(100)
  eventId   String @map("event_id") @db.Uuid

  // Delivery
  payload         Json    @map("payload")
  httpStatus      Int?    @map("http_status")
  responseBody    String? @map("response_body") @db.Text
  responseHeaders Json?   @map("response_headers")

  // Timing
  deliveredAt DateTime? @map("delivered_at")
  duration    Int?      @map("duration")

  // Status
  status      String    @default("pending") @db.VarChar(50)
  attempts    Int       @default(0) @map("attempts")
  maxAttempts Int       @default(3) @map("max_attempts")
  nextRetryAt DateTime? @map("next_retry_at")

  // Error handling
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  webhookEndpoint WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)

  @@index([webhookEndpointId])
  @@index([eventType])
  @@index([status])
  @@index([nextRetryAt])
  @@index([createdAt])
  @@map("webhook_deliveries")
}
